<!DOCTYPE html>
<html>
	<head>
		<title>Mesh</title>
	</head>
	<script type="text/javascript">
const config = {iceServers: [{urls: "stun:stun.1.google.com:19302"}]};
const pc = new RTCPeerConnection(config);
const dc = pc.createDataChannel("chat", {negotiated: true, id: 0});
const log = msg => div.innerHTML += `<br>${msg}`;
dc.onopen = () => chat.select();
dc.onmessage = e => log(`> ${e.data}`);
pc.oniceconnectionstatechange = e => log(pc.iceConnectionState);

async function createOffer() {
  button.disabled = true;
  await pc.setLocalDescription(await pc.createOffer());
  pc.onicecandidate = ({candidate}) => {
    if (candidate) return;
    offer.value = JSON.stringify(pc.localDescription);//pc.localDescription.sdp;
    offer.select();
    answer.placeholder = "Paste answer here";
  };
}

function start() {
chat.onkeypress = function(e) {
  if (e.keyCode != 13) return;
  dc.send(chat.value);
  log(chat.value);
  chat.value = "";
};
		
offer.onkeypress = async function(e) {
  if (e.keyCode != 13 || pc.signalingState != "stable") return;
  button.disabled = offer.disabled = true;
  await pc.setRemoteDescription(JSON.parse(offer.value));//{type: "offer", sdp: offer.value});
  await pc.setLocalDescription(await pc.createAnswer());
  pc.onicecandidate = ({candidate}) => {
    if (candidate) return;
    answer.focus();
    answer.value = JSON.stringify(pc.localDescription);//pc.localDescription.sdp;
    answer.select();
  };
};

answer.onkeypress = function(e) {
  if (e.keyCode != 13 || pc.signalingState != "have-local-offer") return;
  answer.disabled = true;
  pc.setRemoteDescription(JSON.parse(answer.value));//{type: "answer", sdp: answer.value});
};
	//if (window.location.hash == "") {
	//	createOffer();
	//} else {
	//	offer.value = atob(window.location.hash.slice(1))
	//}
}
		
window.onload = start;
	</script>
	<body>
		<button id="button" onclick="createOffer()">Offer:</button>
		<textarea id="offer" placeholder="Paste offer here"></textarea>
		Answer: <textarea id="answer"></textarea><br><div id="div"></div>
		Chat: <input id="chat"><br>
	</body>
</html>
